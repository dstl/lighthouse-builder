---
- name: Install packages used in packaging
  yum:
    name: "{{ item }}"
  with_items:
    - yum-utils
    - createrepo

- name: Collect installed package names
  shell: 'rpm -qa --queryformat "%{name}\n" | sort | grep --invert-match "gpg-pubkey" > {{ remote_repo_location }}/pkg_list'

- name: Download all installed RPMs
  shell: "yumdownloader --destdir {{ remote_repo_location }}/yum $(<{{ remote_repo_location }}/pkg_list)"

- name: Create a yum repo
  shell: "createrepo {{ remote_repo_location }}/yum"
  when: "{{ create_repo_during_package }}"

- name: Ensure ansible installed pips are packaged
  shell: 'pip3.5 download --dest "{{ remote_repo_location }}/pypi" {{ item }}'
  with_items:
    - uwsgi
    - virtualenv
  when: "{{ package_dependencies }}"

- name: Clone lighthouse git repo
  git:
    repo: "{{ lighthouse_repo }}"
    version: "{{ lighthouse_version }}"
    dest: "/opt/dist/git/lighthouse"
    accept_hostkey: True
    key_file: "/var/lib/jenkins/.ssh/github_rsa"
    force: yes
  when: "{{ package_lighthouse_repo }}"

- name: Clone builder git repo
  git:
    repo: "{{ builder_repo }}"
    version: "{{ builder_version }}"
    dest: "/opt/dist/git/lighthouse-builder"
    accept_hostkey: True
    key_file: "/var/lib/jenkins/.ssh/github_rsa"
    force: yes
  when: "{{ package_builder_repo }}"
