- hosts: localhost
  connection: local
  become: true
  vars_files:
    - vars/jenkins.yml
    - vars/site_specific.yml
  roles:
    - geerlingguy.jenkins
    - digi2al.python
    - digi2al.phantomjs
  tasks:
    - name: Ensure Jenkins can sudo
      lineinfile:
        dest: /etc/sudoers
        regexp: 'Defaults\s+requiretty'
        state: absent
    - name: Copy Configuration files over
      template:
        src: 'templates/{{ item.src }}'
        dest: '/var/lib/jenkins/{{ item.dest }}'
        owner: jenkins
        group: jenkins
        mode: "u=rw,g=r,o=r"
      with_items:
        - { src: 'credentials.xml.j2',          dest: 'credentials.xml' }
        - { src: 'jenkins_location.xml.j2',     dest: 'jenkins.model.JenkinsLocationConfiguration.xml' }
        - { src: 'github_configuration.xml.j2', dest: 'github-plugin-configuration.xml' }
        - { src: 'vault_password_file.j2',      dest: '.vault_password_file' }
    - name: Ensure /var/run/postgresql exists
      file:
        state: directory
        path: /var/run/postgresql
        owner: postgres
        group: postgres
        mode: "u=rwx,g=rx,o=rx"
    - name: Ensure $JENKINS_HOME/.ssh exists
      file:
        state: directory
        path: /var/lib/jenkins/.ssh
        owner: jenkins
        group: jenkins
        mode: "u=rwx,g=,o="
    - name: Ensure dist folder exists
      file:
        state: directory
        path: "/opt/dist"
        mode: "u=rwx,g=rwx,o=rwx"
    - name: Install ssh creds
      copy:
        src: 'files/{{ item.src }}'
        dest: '/var/lib/jenkins/.ssh/{{ item.dest }}'
        owner: jenkins
        group: jenkins
        mode: "{{ item.mode }}"
      with_items:
        - { src: 'ssh_rsa',     mode: 'u=rw,g=,o=',   dest: 'github_rsa' }
        - { src: 'ssh_rsa.pub', mode: 'u=rw,g=,o=',   dest: 'github_rsa.pub' }
        - { src: 'ssh_config',  mode: 'u=rw,g=r,o=r', dest: 'config' }
        - { src: 'ssh_hosts',   mode: 'u=rw,g=r,o=r', dest: 'known_hosts' }
    - name: Add Jenkins to sudo
      copy:
        src: files/jenkins.sudo
        dest: /etc/sudoers.d/jenkins
        owner: root
        group: root
        mode: "u=r,g=r,o=r"
    - name: Configure build radiator
      copy:
        src: files/config.xml
        dest: /var/lib/jenkins/config.xml
        owner: jenkins
        group: jenkins
        mode: "u=rw,g=r,o=r"
      notify:
        - restart jenkins
