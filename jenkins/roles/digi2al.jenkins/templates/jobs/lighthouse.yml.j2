- job:
    name: 'lighthouse-build-pullrequests'
    description: 'Do not edit this job through the web!'
    display-name: 'Build Lighthouse PRs'
    scm:
        - git:
            url: git@github.com:dstl/lighthouse.git
            branches:
                - origin/master
            choosing-strategy: inverse
    triggers:
        - github
    builders:
        - github-notifier
        - shell: |
            export VIRTUALENV_LOCATION="$WORKSPACE/virtualenv"
            export DOWNLOAD_LOCATION="{{ jenkins_pypi_dist_location }}"
            $WORKSPACE/bin/jenkins.sh
    wrappers:
        - ansicolor
    publishers:
        - github-notifier

- job:
    name: 'lighthouse-build'
    description: 'Do not edit this job through the web!'
    display-name: 'Build Lighthouse'
    scm:
        - git:
            url: git@github.com:dstl/lighthouse.git
            branches:
                - origin/master
    triggers:
        - github
        - reverse:
            jobs: 'update-jenkins'
            result: 'success'
    builders:
        - github-notifier
        - shell: |
            export VIRTUALENV_LOCATION="$WORKSPACE/virtualenv"
            export DOWNLOAD_LOCATION="{{ jenkins_pypi_dist_location }}"
            $WORKSPACE/bin/jenkins.sh
    wrappers:
        - ansicolor
    publishers:
        - github-notifier

- job:
    name: 'lighthouse-deploy'
    description: 'Do not edit this job through the web!'
    display-name: 'Deploy Lighthouse'
    scm:
        - git:
            url: git@github.com:livestax/dstl-infrastructure.git
            branches:
                - origin/master
            submodule:
                recursive: true
    triggers:
        - github
        - reverse:
            jobs: 'lighthouse-build'
            result: 'success'
    builders:
        - shell: |
            export ANSIBLE_HOST_KEY_CHECKING=False
            ansible-playbook -i {{ lighthouse_inventory_file }} $WORKSPACE/playbook.yml
    wrappers:
        - ansicolor

- job:
    name: 'lighthouse-acceptance-test'
    description: 'Do not edit this job through the web!'
    display-name: 'Acceptance Test Lighthouse'
    scm:
        - git:
            url: git@github.com:dstl/lighthouse.git
            branches:
                - origin/master
    triggers:
        - reverse:
            jobs: 'lighthouse-deploy'
            result: 'success'
    builders:
        - shell: |
            export PATH="/usr/local/bin:$PATH"
            export LIGHTHOUSE_HOST="{{ lighthouse_host }}"
            export DOWNLOAD_LOCATION="{{ jenkins_pypi_dist_location }}"
            $WORKSPACE/bin/acceptance-test.sh
    wrappers:
        - ansicolor


- project:
    name: lighthouse
    jobs:
        - 'lighthouse-build'
        - 'lighthouse-build-pullrequests'
        - 'lighthouse-deploy'
